<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø±Ø§Ø¯ÙŠÙˆ ØªÙØ§Ø¹Ù„ÙŠ - Ù…Ù† Ø£ÙŠÙ† ØªØ¨Ø« Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¥Ø°Ø§Ø¹ÙŠØ©</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>

  <!-- Ø¯Ø¹Ù… ØªØ´ØºÙŠÙ„ HLS (m3u8) Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… HLS Ù…Ø¨Ø§Ø´Ø±Ø© -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Cairo', sans-serif; }

    .radio-body {
      background: linear-gradient(145deg, #8B4513 0%, #5D3A1A 50%, #3D2512 100%);
      border: 8px solid #2D1810;
      box-shadow:
        inset 0 2px 10px rgba(255,255,255,0.1),
        0 20px 40px rgba(0,0,0,0.5),
        0 0 0 4px #4A3020;
    }

    .dial-track {
      background: linear-gradient(to bottom, #1a1a1a, #333, #1a1a1a);
      border: 3px solid #444;
    }

    .dial-knob {
      background: linear-gradient(145deg, #FFD700, #B8860B, #8B6914);
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      cursor: grab;
    }
    .dial-knob:active { cursor: grabbing; }

    .frequency-display {
      background: linear-gradient(to bottom, #0a1628, #1a3050);
      border: 4px solid #2D1810;
      box-shadow: inset 0 0 20px rgba(0,255,150,0.1);
    }

    .signal-led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    .led-off { background: #333; box-shadow: none; }
    .led-red { background: #ff4444; box-shadow: 0 0 10px #ff4444, 0 0 20px #ff4444; }
    .led-yellow { background: #ffaa00; box-shadow: 0 0 10px #ffaa00, 0 0 20px #ffaa00; }
    .led-green { background: #00ff88; box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88; }

    .noise-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      opacity: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.3) 2px,
        rgba(0,0,0,0.3) 4px
      );
      animation: noise 0.1s infinite;
    }

    @keyframes noise {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .static-text { animation: staticFlicker 0.1s infinite; }
    @keyframes staticFlicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .speaker-grille {
      background: repeating-linear-gradient(
        90deg,
        #2D1810,
        #2D1810 3px,
        #1a0f08 3px,
        #1a0f08 6px
      );
    }

    .golden-accent { background: linear-gradient(90deg, #8B6914, #FFD700, #8B6914); }

    .table-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }

    input:focus, select:focus {
      outline: none;
      border-color: #8B4513;
      box-shadow: 0 0 0 3px rgba(139,69,19,0.2);
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
</head>

<body class="h-full bg-gradient-to-br from-amber-900 via-amber-800 to-stone-900 overflow-auto">
  <div class="w-full min-h-full p-4 md:p-8">

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="text-center mb-8">
      <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-amber-100 mb-2 drop-shadow-lg">ğŸ™ï¸ Ù…Ù† Ø£ÙŠÙ† ØªØ¨Ø« Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¥Ø°Ø§Ø¹ÙŠØ©ØŸ</h1>
      <p class="text-amber-200/80 text-lg">ØªØ¬Ø±Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø§Ø³ØªÙƒØ´Ø§Ù Ù…ÙˆØ¬Ø§Øª Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ</p>
    </div>

    <!-- Ø¬Ø³Ù… Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ -->
    <div class="max-w-4xl mx-auto">
      <div class="radio-body rounded-3xl p-6 md:p-8">

        <div class="golden-accent h-2 rounded-full mb-6"></div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
        <div class="frequency-display rounded-xl p-4 mb-6">
          <div class="relative">
            <div id="noise-overlay" class="noise-overlay rounded-lg"></div>

            <!-- Ø§Ù„ØªØ±Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="text-center mb-4">
              <span class="text-green-400/60 text-sm">FM/AM</span>
              <div id="current-frequency" class="text-5xl md:text-6xl font-bold text-green-400 tracking-wider"
                   style="text-shadow: 0 0 20px rgba(0,255,150,0.5);">
                540 <span class="text-2xl">KHz</span>
              </div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø·Ø© -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-green-400/60 text-xs mb-1">Ø§Ø³Ù… Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©</div>
                <div id="station-name" class="text-green-400 font-bold text-sm md:text-base">---</div>
              </div>
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-green-400/60 text-xs mb-1">Ù…ÙƒØ§Ù† Ø§Ù„Ø¨Ø«</div>
                <div id="broadcast-location" class="text-green-400 font-bold text-sm md:text-base">---</div>
              </div>
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-green-400/60 text-xs mb-1">Ø§Ù„ØªØ±Ø¯Ø¯</div>
                <div id="frequency-display" class="text-green-400 font-bold text-sm md:text-base">--- KHz</div>
              </div>
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-green-400/60 text-xs mb-1">Ø§Ù„Ø¨Ø¹Ø¯</div>
                <div id="distance-display" class="text-green-400 font-bold text-sm md:text-base">--- Km</div>
              </div>
            </div>

            <!-- âœ… ØªØ­ÙƒÙ… Ø§Ù„ØµÙˆØª -->
            <div class="mt-4 bg-black/20 rounded-xl p-4">
              <div class="flex flex-col md:flex-row gap-3 items-center justify-between">
                <div class="text-amber-200 font-bold">ğŸ”Š Ø§Ù„ØµÙˆØª</div>

                <div class="flex gap-2 items-center">
                  <button id="play-btn"
                          class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg transition shadow">
                    â–¶ï¸ ØªØ´ØºÙŠÙ„
                  </button>
                  <button id="stop-btn"
                          class="bg-stone-600 hover:bg-stone-700 text-white font-bold px-4 py-2 rounded-lg transition shadow">
                    â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù
                  </button>
                </div>

                <div class="flex items-center gap-2 w-full md:w-72">
                  <span class="text-amber-200/80 text-sm">Ø§Ù„ØµÙˆØª</span>
                  <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" class="w-full accent-amber-500">
                </div>

                <div id="audio-state" class="text-amber-200/80 text-sm text-center md:text-left">
                  Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø­Ø·Ø© Ø«Ù… Ø§Ø¶ØºØ·ÙŠ ØªØ´ØºÙŠÙ„
                </div>
              </div>

              <!-- Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ø­Ø·Ø© -->
              <audio id="station-audio" playsinline crossorigin="anonymous"></audio>
            </div>

          </div>
        </div>

        <!-- Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØ±Ø¯Ø¯ -->
        <div class="mb-6">
          <div class="flex justify-between text-amber-200/80 text-sm mb-2 px-2">
            <span>540</span> <span>700</span> <span>900</span> <span>1100</span> <span>1300</span> <span>1500</span> <span>1600</span>
          </div>

          <div class="dial-track rounded-full h-8 relative">
            <!-- Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø­Ø·Ø§Øª -->
            <div class="absolute top-0 h-full flex items-center" style="left: calc((621 - 540) / (1600 - 540) * 100%);">
              <div class="w-1 h-4 bg-red-500 rounded"></div>
            </div>
            <div class="absolute top-0 h-full flex items-center" style="left: calc((1161 - 540) / (1600 - 540) * 100%);">
              <div class="w-1 h-4 bg-yellow-500 rounded"></div>
            </div>

            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div id="dial-knob"
                 class="dial-knob absolute top-1/2 -translate-y-1/2 w-8 h-8 rounded-full flex items-center justify-center"
                 style="left: 0%;">
              <div class="w-1 h-4 bg-amber-900 rounded"></div>
            </div>
          </div>

          <div class="flex justify-between mt-2 px-2">
            <span class="text-xs text-red-400">â— Ø§Ù„Ø±ÙŠØ§Ø¶ (621)</span>
            <span class="text-xs text-yellow-400">â— Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© (1161)</span>
          </div>
        </div>

        <!-- Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© -->
        <div class="bg-black/20 rounded-xl p-4 mb-6">
          <div class="text-amber-200 font-bold mb-3 text-center">ğŸ“¡ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</div>
          <div class="flex justify-center items-center gap-6">
            <div class="flex flex-col items-center">
              <div id="led-weak" class="signal-led led-off mb-2"></div><span class="text-amber-200/60 text-xs">Ø¶Ø¹ÙŠÙØ©</span>
            </div>
            <div class="flex flex-col items-center">
              <div id="led-medium" class="signal-led led-off mb-2"></div><span class="text-amber-200/60 text-xs">Ù…ØªÙˆØ³Ø·Ø©</span>
            </div>
            <div class="flex flex-col items-center">
              <div id="led-strong" class="signal-led led-off mb-2"></div><span class="text-amber-200/60 text-xs">Ù‚ÙˆÙŠØ©</span>
            </div>
          </div>
          <div id="signal-status" class="text-center mt-3 text-amber-100 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø©</div>
        </div>

        <div class="speaker-grille h-16 rounded-xl"></div>
        <div class="golden-accent h-2 rounded-full mt-6"></div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div class="max-w-4xl mx-auto mt-8">
      <div class="table-container rounded-2xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-amber-800 to-amber-700 p-4">
          <h2 class="text-xl font-bold text-white text-center">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¥Ø°Ø§Ø¹ÙŠØ©</h2>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
        <div class="p-4 bg-amber-50 border-b-2 border-amber-200">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <input type="text" id="input-frequency" placeholder="Ø§Ù„ØªØ±Ø¯Ø¯ KHz" class="p-2 border-2 border-amber-300 rounded-lg text-center">
            <input type="text" id="input-station" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©" class="p-2 border-2 border-amber-300 rounded-lg text-center">
            <select id="input-signal" class="p-2 border-2 border-amber-300 rounded-lg text-center bg-white">
              <option value="">Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</option>
              <option value="Ù‚ÙˆÙŠØ©">Ù‚ÙˆÙŠØ©</option>
              <option value="Ù…ØªÙˆØ³Ø·Ø©">Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="Ø¶Ø¹ÙŠÙØ©">Ø¶Ø¹ÙŠÙØ©</option>
            </select>
            <input type="text" id="input-location" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø¨Ø«" class="p-2 border-2 border-amber-300 rounded-lg text-center">
            <input type="text" id="input-distance" placeholder="Ø§Ù„Ø¨Ø¹Ø¯ Km" class="p-2 border-2 border-amber-300 rounded-lg text-center">
          </div>

          <button id="add-btn"
                  class="w-full mt-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold py-3 rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-lg">
            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©
          </button>
        </div>

        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-amber-100">
              <tr>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ø§Ù„ØªØ±Ø¯Ø¯ KHz</th>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©</th>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</th>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ù…ÙƒØ§Ù† Ø§Ù„Ø¨Ø«</th>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ø§Ù„Ø¨Ø¹Ø¯ Km</th>
                <th class="p-3 text-amber-900 font-bold border-b-2 border-amber-200">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="stations-table"></tbody>
          </table>
        </div>

        <div id="empty-message" class="p-8 text-center text-amber-600">
          <span class="text-4xl mb-2 block">ğŸ“»</span> Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø­Ø·Ø§Øª Ø¨Ø¹Ø¯
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
    <footer class="text-center mt-8 pb-4">
      <div class="inline-block bg-amber-900/50 backdrop-blur rounded-xl px-6 py-3">
        <p id="footer-text" class="text-amber-200 font-bold">ØªØµÙ…ÙŠÙ… Ù†ÙˆÙ Ø®Ø¨ØªÙŠ - Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø¨ÙŠØ´Ø© Ù…Ø³Ø§Ø±Ø§Øª</p>
      </div>
    </footer>

  </div>

  <script>
    // Default configuration
    const defaultConfig = {
      main_title: 'ğŸ™ï¸ Ù…Ù† Ø£ÙŠÙ† ØªØ¨Ø« Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø§Ù„Ø¥Ø°Ø§Ø¹ÙŠØ©ØŸ',
      footer_text: 'ØªØµÙ…ÙŠÙ… Ù†ÙˆÙ Ø®Ø¨ØªÙŠ - Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø¨ÙŠØ´Ø© Ù…Ø³Ø§Ø±Ø§Øª',
      background_color: '#78350f',
      surface_color: '#8B4513',
      text_color: '#fef3c7',
      primary_color: '#d97706',
      accent_color: '#00ff88'
    };

    // âœ… Ù…Ø­Ø·Ø§Øª + Ø±ÙˆØ§Ø¨Ø·
    const stations = {
      riyadh: {
        name: 'Ø¥Ø°Ø§Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¶',
        location: 'Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',
        frequency: 621,
        distance: 450,
        signalStrength: 'strong',
        noisy: false, // âœ… ØµØ§ÙÙŠØ©
        streamUrl: 'https://edge.taghtia.com/sa/12.m3u8'
      },
      cairo: {
        name: 'Ø¥Ø°Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰',
        location: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±',
        frequency: 1161,
        distance: 1200,
        signalStrength: 'weak',
        noisy: true, // âœ… ØªØ´ÙˆÙŠØ´ ÙÙ‚Ø· Ù‡Ù†Ø§
        streamUrl: 'https://www.maspero.eg/stream/14'
      }
    };

    let currentFrequency = 540;
    let isDragging = false;
    let stationsData = [];
    let deleteConfirmId = null;

    // DOM Elements
    const dialKnob = document.getElementById('dial-knob');
    const currentFrequencyDisplay = document.getElementById('current-frequency');
    const stationName = document.getElementById('station-name');
    const broadcastLocation = document.getElementById('broadcast-location');
    const frequencyDisplay = document.getElementById('frequency-display');
    const distanceDisplay = document.getElementById('distance-display');
    const noiseOverlay = document.getElementById('noise-overlay');
    const ledWeak = document.getElementById('led-weak');
    const ledMedium = document.getElementById('led-medium');
    const ledStrong = document.getElementById('led-strong');
    const signalStatus = document.getElementById('signal-status');
    const stationsTable = document.getElementById('stations-table');
    const emptyMessage = document.getElementById('empty-message');
    const addBtn = document.getElementById('add-btn');

    // âœ… Audio controls
    const stationAudio = document.getElementById('station-audio');
    const playBtn = document.getElementById('play-btn');
    const stopBtn = document.getElementById('stop-btn');
    const vol = document.getElementById('vol');
    const audioState = document.getElementById('audio-state');

    stationAudio.preload = 'none';
    stationAudio.volume = Number(vol.value);

    let isPlaying = false;
    let activeStationKey = null;
    let lastStationKey = null;
    let hls = null;

    // âœ… WebAudio Ù„Ù„ØªØ´ÙˆÙŠØ´ ÙÙ‚Ø· (Ù„Ø§ Ù†Ù…Ø³ ØµÙˆØª Ø§Ù„Ù…Ø­Ø·Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØ®ØªÙÙŠ)
    let audioCtx = null;
    let noiseNode = null;
    let noiseGain = null;

    function ensureNoise() {
      if (audioCtx) return;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¶Ø¬ÙŠØ¬ Ø£Ø¨ÙŠØ¶
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

      noiseNode = audioCtx.createBufferSource();
      noiseNode.buffer = noiseBuffer;
      noiseNode.loop = true;

      noiseGain = audioCtx.createGain();
      noiseGain.gain.value = 0; // Ø§ÙØªØ±Ø§Ø¶ÙŠ: ØµØ§Ù…Øª

      noiseNode.connect(noiseGain).connect(audioCtx.destination);
      noiseNode.start(0);
    }

    function setNoiseForStation(station) {
      // ØªØ´ÙˆÙŠØ´ Ø¨ØµØ±ÙŠ ÙÙ‚Ø· Ù„Ù„Ù‚Ø§Ù‡Ø±Ø© (Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ Ø´ØºÙ‘Ù„ØªÙŠ Ø§Ù„ØµÙˆØª)
      noiseOverlay.style.opacity = station?.noisy ? '0.3' : '0';

      // ØªØ´ÙˆÙŠØ´ ØµÙˆØªÙŠ (ÙŠÙØ³Ù…Ø¹ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„)
      if (!audioCtx || !noiseGain) return;
      noiseGain.gain.value = (isPlaying && station?.noisy) ? 0.18 : 0; // Ø§Ù„Ø±ÙŠØ§Ø¶ = 0
    }

    function destroyHls() {
      if (hls) {
        try { hls.destroy(); } catch(e) {}
        hls = null;
      }
    }

    function setAudioSource(url) {
      destroyHls();

      // Ù„Ùˆ Ø±Ø§Ø¨Ø· m3u8
      const isM3U8 = /\.m3u8(\?|$)/i.test(url);

      if (isM3U8) {
        // Safari ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ´ØºÙ‘Ù„ HLS Ù…Ø¨Ø§Ø´Ø±Ø©
        if (stationAudio.canPlayType('application/vnd.apple.mpegurl')) {
          stationAudio.src = url;
        } else if (window.Hls && window.Hls.isSupported()) {
          hls = new Hls({ lowLatencyMode: true });
          hls.loadSource(url);
          hls.attachMedia(stationAudio);
        } else {
          stationAudio.src = url;
        }
      } else {
        // mp3/aac/â€¦ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø¹Ø§Ø¯ÙŠ
        stationAudio.src = url;
      }
    }

    async function playCurrentStation() {
      if (!activeStationKey) {
        audioState.textContent = 'Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø­Ø·Ø© Ø£ÙˆÙ„Ù‹Ø§';
        return;
      }

      const st = stations[activeStationKey];
      if (!st?.streamUrl) {
        audioState.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØµÙˆØª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø·Ø©';
        return;
      }

      // Ø¬Ù‡Ù‘Ø²ÙŠ Ø§Ù„ØªØ´ÙˆÙŠØ´
      ensureNoise();
      if (audioCtx.state === 'suspended') {
        await audioCtx.resume().catch(() => {});
      }

      // Ø¬Ù‡Ø²ÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø©
      if (activeStationKey !== lastStationKey) {
        setAudioSource(st.streamUrl);
        lastStationKey = activeStationKey;
      }

      try {
        audioState.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...';
        await stationAudio.play();
        isPlaying = true;
        playBtn.textContent = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        audioState.textContent = 'âœ… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†';
        setNoiseForStation(st); // âœ… Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙÙ‚Ø·
      } catch (e) {
        isPlaying = false;
        playBtn.textContent = 'â–¶ï¸ ØªØ´ØºÙŠÙ„';
        audioState.textContent = 'âŒ Ù„Ù… ÙŠØ³Ù…Ø­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ØµÙˆØª â€” Ø§Ø¶ØºØ·ÙŠ ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
        // Ù…Ù‡Ù…: Ù„Ø§ ØªØ´ÙˆÙŠØ´ ØµÙˆØªÙŠ Ø¨Ø¯ÙˆÙ† ØªØ´ØºÙŠÙ„
        setNoiseForStation(st);
      }
    }

    function pauseAudio() {
      try { stationAudio.pause(); } catch(e) {}
      isPlaying = false;
      playBtn.textContent = 'â–¶ï¸ ØªØ´ØºÙŠÙ„';
      audioState.textContent = 'Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªÙ‹Ø§';

      // Ø¥Ø·ÙØ§Ø¡ Ø§Ù„ØªØ´ÙˆÙŠØ´ Ø§Ù„ØµÙˆØªÙŠ ÙÙˆØ±Ù‹Ø§ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)
      if (audioCtx && noiseGain) noiseGain.gain.value = 0;
    }

    function stopAllAudio() {
      try { stationAudio.pause(); } catch(e) {}
      stationAudio.removeAttribute('src');
      stationAudio.load();
      destroyHls();

      isPlaying = false;
      playBtn.textContent = 'â–¶ï¸ ØªØ´ØºÙŠÙ„';
      audioState.textContent = 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';

      if (audioCtx && noiseGain) noiseGain.gain.value = 0;
    }

    playBtn.addEventListener('click', async () => {
      if (!activeStationKey) {
        audioState.textContent = 'Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø­Ø·Ø© Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø¤Ø´Ø± Ø«Ù… Ø§Ø¶ØºØ·ÙŠ ØªØ´ØºÙŠÙ„';
        return;
      }
      if (!isPlaying) await playCurrentStation();
      else pauseAudio();
    });

    stopBtn.addEventListener('click', () => stopAllAudio());

    vol.addEventListener('input', () => {
      stationAudio.volume = Number(vol.value);
    });

    stationAudio.addEventListener('waiting', () => { if (isPlaying) audioState.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; });
    stationAudio.addEventListener('playing', () => { if (isPlaying) audioState.textContent = 'âœ… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†'; });
    stationAudio.addEventListener('error', () => {
      audioState.textContent = 'âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø·Ø©';
      // Ø¥Ø·ÙØ§Ø¡ Ø§Ù„ØªØ´ÙˆÙŠØ´ Ø§Ù„ØµÙˆØªÙŠ
      if (audioCtx && noiseGain) noiseGain.gain.value = 0;
    });

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
          document.getElementById('footer-text').textContent = config.footer_text || defaultConfig.footer_text;
          document.body.style.background =
            `linear-gradient(to bottom right, ${config.background_color || defaultConfig.background_color}, ${config.surface_color || defaultConfig.surface_color}, #1c1917)`;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
            { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
            { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
            { get: () => config.primary_color || defaultConfig.primary_color, set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); } },
            { get: () => config.accent_color || defaultConfig.accent_color, set: (v) => { config.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); } }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['main_title', config.main_title || defaultConfig.main_title],
          ['footer_text', config.footer_text || defaultConfig.footer_text]
        ])
      });
    }

    // Initialize Data SDK
    const dataHandler = { onDataChanged(data) { stationsData = data; renderTable(); } };

    async function initDataSdk() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) console.error('Failed to initialize data SDK');
      }
    }
    initDataSdk();

    // Radio dial functionality
    function updateFrequencyDisplay() {
      const minFreq = 540;
      const maxFreq = 1600;
      const range = maxFreq - minFreq;
      const percentage = (currentFrequency - minFreq) / range * 100;

      dialKnob.style.left = `calc(${percentage}% - 16px)`;
      currentFrequencyDisplay.innerHTML = `${Math.round(currentFrequency)} <span class="text-2xl">KHz</span>`;

      let foundStation = null;
      let foundKey = null;
      const tolerance = 20;

      if (Math.abs(currentFrequency - stations.riyadh.frequency) < tolerance) {
        foundStation = stations.riyadh;
        foundKey = 'riyadh';
      } else if (Math.abs(currentFrequency - stations.cairo.frequency) < tolerance) {
        foundStation = stations.cairo;
        foundKey = 'cairo';
      }

      if (foundStation) {
        activeStationKey = foundKey;

        stationName.textContent = foundStation.name;
        stationName.className = foundStation.noisy
          ? 'text-green-400 font-bold text-sm md:text-base static-text'
          : 'text-green-400 font-bold text-sm md:text-base';

        broadcastLocation.textContent = foundStation.location;
        frequencyDisplay.textContent = `${foundStation.frequency} KHz`;
        distanceDisplay.textContent = `${foundStation.distance} Km`;

        // âœ… ØªØ´ÙˆÙŠØ´ ÙÙ‚Ø· Ù„Ù„Ù‚Ø§Ù‡Ø±Ø© (Ø¨ØµØ±ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§ØŒ ÙˆØµÙˆØªÙŠ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„)
        ensureNoise();
        setNoiseForStation(foundStation);

        // LEDs
        updateSignalLeds(foundStation.signalStrength);

        if (foundStation.signalStrength === 'strong') {
          signalStatus.textContent = 'âœ… Ø¥Ø´Ø§Ø±Ø© Ù‚ÙˆÙŠØ© ÙˆÙˆØ§Ø¶Ø­Ø©';
          signalStatus.className = 'text-center mt-3 text-green-400 font-bold';
        } else if (foundStation.signalStrength === 'medium') {
          signalStatus.textContent = 'âš ï¸ Ø¥Ø´Ø§Ø±Ø© Ù…ØªÙˆØ³Ø·Ø©';
          signalStatus.className = 'text-center mt-3 text-yellow-400 font-bold';
        } else {
          signalStatus.textContent = 'ğŸ“¡ Ø¥Ø´Ø§Ø±Ø© Ø¶Ø¹ÙŠÙØ©';
          signalStatus.className = 'text-center mt-3 text-red-400 font-bold';
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ ÙˆØºÙŠÙ‘Ø±ØªÙŠ Ø§Ù„Ù…Ø­Ø·Ø© -> Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ù…ØµØ¯Ø± ÙÙˆØ±Ù‹Ø§
        if (isPlaying && foundKey !== lastStationKey) {
          playCurrentStation();
        }

      } else {
        activeStationKey = null;

        stationName.textContent = '---';
        stationName.className = 'text-green-400 font-bold text-sm md:text-base';
        broadcastLocation.textContent = '---';
        frequencyDisplay.textContent = '--- KHz';
        distanceDisplay.textContent = '--- Km';

        noiseOverlay.style.opacity = '0';
        if (audioCtx && noiseGain) noiseGain.gain.value = 0;

        updateSignalLeds('none');

        signalStatus.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø©';
        signalStatus.className = 'text-center mt-3 text-amber-100 font-bold';
      }
    }

    function updateSignalLeds(strength) {
      ledWeak.className = 'signal-led led-off';
      ledMedium.className = 'signal-led led-off';
      ledStrong.className = 'signal-led led-off';

      if (strength === 'weak') {
        ledWeak.className = 'signal-led led-red';
      } else if (strength === 'medium') {
        ledWeak.className = 'signal-led led-red';
        ledMedium.className = 'signal-led led-yellow';
      } else if (strength === 'strong') {
        ledWeak.className = 'signal-led led-red';
        ledMedium.className = 'signal-led led-yellow';
        ledStrong.className = 'signal-led led-green';
      }
    }

    // Dial interaction
    const dialTrack = document.querySelector('.dial-track');

    function handleDrag(e) {
      if (!isDragging) return;

      const rect = dialTrack.getBoundingClientRect();
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      let x = clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));

      const percentage = x / rect.width;
      currentFrequency = 540 + percentage * (1600 - 540);
      updateFrequencyDisplay();
    }

    dialKnob.addEventListener('mousedown', () => isDragging = true);
    dialKnob.addEventListener('touchstart', () => isDragging = true);
    document.addEventListener('mousemove', handleDrag);
    document.addEventListener('touchmove', handleDrag);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('touchend', () => isDragging = false);

    dialTrack.addEventListener('click', (e) => {
      const rect = dialTrack.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percentage = x / rect.width;
      currentFrequency = 540 + percentage * (1600 - 540);
      updateFrequencyDisplay();
    });

    // Table functionality
    function renderTable() {
      const tbody = stationsTable;

      const existingRows = tbody.querySelectorAll('tr[data-id]');
      existingRows.forEach(row => {
        const id = row.dataset.id;
        if (!stationsData.find(s => s.__backendId === id)) {
          row.remove();
        }
      });

      stationsData.forEach((station, index) => {
        let row = tbody.querySelector(`tr[data-id="${station.__backendId}"]`);

        if (!row) {
          row = document.createElement('tr');
          row.dataset.id = station.__backendId;
          row.className = index % 2 === 0 ? 'bg-white' : 'bg-amber-50';
          tbody.appendChild(row);
        }

        const isConfirming = deleteConfirmId === station.__backendId;

        row.innerHTML = `
          <td class="p-3 text-center border-b border-amber-100">${station.frequency}</td>
          <td class="p-3 text-center border-b border-amber-100 font-bold text-amber-800">${station.station_name}</td>
          <td class="p-3 text-center border-b border-amber-100">
            <span class="px-2 py-1 rounded-full text-xs font-bold ${
              station.signal_strength === 'Ù‚ÙˆÙŠØ©' ? 'bg-green-100 text-green-700' :
              station.signal_strength === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'bg-yellow-100 text-yellow-700' :
              'bg-red-100 text-red-700'
            }">${station.signal_strength}</span>
          </td>
          <td class="p-3 text-center border-b border-amber-100">${station.broadcast_location}</td>
          <td class="p-3 text-center border-b border-amber-100">${station.distance}</td>
          <td class="p-3 text-center border-b border-amber-100">
            ${isConfirming ? `
              <div class="flex gap-1 justify-center">
                <button onclick="confirmDelete('${station.__backendId}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">ØªØ£ÙƒÙŠØ¯</button>
                <button onclick="cancelDelete()" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">Ø¥Ù„ØºØ§Ø¡</button>
              </div>
            ` : `
              <button onclick="startDelete('${station.__backendId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm transition-colors">ğŸ—‘ï¸</button>
            `}
          </td>
        `;
      });

      emptyMessage.style.display = stationsData.length === 0 ? 'block' : 'none';
    }

    window.startDelete = function(id) {
      deleteConfirmId = id;
      renderTable();
    };

    window.cancelDelete = function() {
      deleteConfirmId = null;
      renderTable();
    };

    window.confirmDelete = async function(id) {
      const station = stationsData.find(s => s.__backendId === id);
      if (station && window.dataSdk) {
        const btn = document.querySelector(`tr[data-id="${id}"] button`);
        if (btn) btn.disabled = true;

        const result = await window.dataSdk.delete(station);
        if (!result.isOk) console.error('Failed to delete station');
        deleteConfirmId = null;
      }
    };

    // Add station
    addBtn.addEventListener('click', async () => {
      const frequency = document.getElementById('input-frequency').value.trim();
      const stationNameInput = document.getElementById('input-station').value.trim();
      const signal = document.getElementById('input-signal').value;
      const location = document.getElementById('input-location').value.trim();
      const distance = document.getElementById('input-distance').value.trim();

      if (!frequency || !stationNameInput || !signal || !location || !distance) {
        addBtn.textContent = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„';
        addBtn.className = 'w-full mt-3 bg-red-500 text-white font-bold py-3 rounded-lg';
        setTimeout(() => {
          addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©';
          addBtn.className = 'w-full mt-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold py-3 rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-lg';
        }, 2000);
        return;
      }

      if (stationsData.length >= 999) {
        addBtn.textContent = 'âš ï¸ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (999)';
        addBtn.className = 'w-full mt-3 bg-red-500 text-white font-bold py-3 rounded-lg';
        setTimeout(() => {
          addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©';
          addBtn.className = 'w-full mt-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold py-3 rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-lg';
        }, 2000);
        return;
      }

      if (window.dataSdk) {
        addBtn.disabled = true;
        addBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

        const result = await window.dataSdk.create({
          frequency,
          station_name: stationNameInput,
          signal_strength: signal,
          broadcast_location: location,
          distance
        });

        addBtn.disabled = false;

        if (result.isOk) {
          document.getElementById('input-frequency').value = '';
          document.getElementById('input-station').value = '';
          document.getElementById('input-signal').value = '';
          document.getElementById('input-location').value = '';
          document.getElementById('input-distance').value = '';

          addBtn.textContent = 'âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©';
          setTimeout(() => { addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©'; }, 1500);
        } else {
          addBtn.textContent = 'âŒ ÙØ´Ù„Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©';
          setTimeout(() => { addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©'; }, 2000);
        }

        addBtn.className = 'w-full mt-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold py-3 rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all shadow-lg';
      }
    });

    // Initialize
    updateFrequencyDisplay();
  </script>
</body>
</html>
